{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[deployment().location]",
            "metadata": {
                "description": "Location for the JumpStart scenario deployment"
            }
        },
        "azureRgName": {
            "type": "string",
            "defaultValue": "Azure-RG",
            "metadata": {
                "description": "Name for the Resource Group which will imitate an Azure cloud environment"
            }
        },
        "onPremRgName": {
            "type": "string",
            "defaultValue": "OnPrem-RG",
            "metadata": {
                "description": "Name for the Resource Group which will imitate an on-premises environment"
            }
        },
        "sqlAdminLogin": {
            "type": "string",
            "defaultValue": "sqladmin",
            "metadata": {
                "description": "Admin login for the SQL Server"
            }
        },
        "sqlAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for the SQL Server"
            }
        },
        "cloudVNetName": {
            "type": "string",
            "defaultValue": "Azure-NET",
            "metadata": {
                "description": "Name of the first VNET."
            }
        },
        "cloudVNetPrefix": {
            "type": "string",
            "defaultValue": "172.16.0.0/24",
            "metadata": {
                "description": "Address space for the first VNET."
            }
        },
        "cloudSubnetName": {
            "type": "string",
            "defaultValue": "Resources",
            "metadata": {
                "description": "Name of the first subnet in the first VNET. Please note, an additional subnet called GatewaySubnet will be created where the VirtualNetworkGateway will be deployed. The name of that subnet must not be changed from GatewaySubnet."
            }
        },
        "cloudGatewaySubnetPrefix": {
            "type": "string",
            "defaultValue": "172.16.0.0/26",
            "metadata": {
                "description": "The prefix for the first subnet in the first VNET."
            }
        },
        "cloudSubnetPrefix": {
            "type": "string",
            "defaultValue": "172.16.0.64/26",
            "metadata": {
                "description": "The prefix for the first subnet in the first VNET."
            }
        },
        "cloudGatewayName": {
            "type": "string",
            "defaultValue": "AzureGateway",
            "metadata": {
                "description": "The prefix for the first subnet in the first VNET."
            }
        },
        "vmName": {
            "type": "string",
            "defaultValue": "ArcDemo-VM",
            "metadata": {
                "description": "Username for the Virtual Machine."
            }
        },
        "vmSize": {
            "type": "string",
            "defaultValue": "Standard_D4s_v4",
            "metadata": {
                "description": "Size of the Virtual Machine"
            }
        },
        "adminUsername": {
            "type": "string",
            "defaultValue": "arcadmin",
            "metadata": {
                "description": "Username for the Virtual Machine."
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "SSH Key or password for the Virtual Machine. SSH key is recommended."
            }
        },
        "onPremVNetName": {
            "type": "string",
            "defaultValue": "OnPrem-NET",
            "metadata": {
                "description": "Name of the first VNET."
            }
        },
        "onPremVNetPrefix": {
            "type": "string",
            "defaultValue": "192.168.0.0/24",
            "metadata": {
                "description": "Address space for the first VNET."
            }
        },
        "onPremGatewaySubnetPrefix": {
            "type": "string",
            "defaultValue": "192.168.0.0/26",
            "metadata": {
                "description": "The prefix for the first subnet in the first VNET."
            }
        },
        "onPremBastionSubnetPrefix": {
            "type": "string",
            "defaultValue": "192.168.0.64/26",
            "metadata": {
                "description": "The prefix for the first subnet in the first VNET."
            }
        },
        "onPremSubnetName": {
            "type": "string",
            "defaultValue": "default",
            "metadata": {
                "description": "Name of the first subnet in the first VNET. Please note, an additional subnet called GatewaySubnet will be created where the VirtualNetworkGateway will be deployed. The name of that subnet must not be changed from GatewaySubnet."
            }
        },
        "onPremSubnetPrefix": {
            "type": "string",
            "defaultValue": "192.168.0.128/26",
            "metadata": {
                "description": "The prefix for the first subnet in the first VNET."
            }
        },
        "onPremGatewayName": {
            "type": "string",
            "defaultValue": "OnPremGateway",
            "metadata": {
                "description": "The prefix for the first subnet in the first VNET."
            }
        },
        "onPremBastionName": {
            "type": "string",
            "defaultValue": "OnPremBastion",
            "metadata": {
                "description": "The prefix for the first subnet in the first VNET."
            }
        },
        "sharedKey": {
            "type": "securestring",
            "defaultValue": "microsoft",
            "metadata": {
                "description": "GitHub Account"
            }
        },
        "githubAccount": {
            "type": "string",
            "defaultValue": "microsoft",
            "metadata": {
                "description": "GitHub Account"
            }
        },
        "githubBranch": {
            "type": "string",
            "defaultValue": "main",
            "metadata": {
                "description": "GitHub Branch"
            }
        }
    },
    "variables": {
        "scenarioUrl": "[concat('https://raw.githubusercontent.com/', parameters('githubAccount'), '/azure_arc/', parameters('githubBranch'), '/azure_arc_servers_jumpstart/privatelink/')]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2021-04-01",
            "name": "[parameters('azureRgName')]",
            "location": "[parameters('location')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2021-04-01",
            "name": "[parameters('onPremRgName')]",
            "location": "[parameters('location')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "AzureDeployment",
            "resourceGroup": "[parameters('azureRgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups', parameters('azureRgName'))]"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/DCMattyG/azure_arc/privatelink/azure_arc_servers_jumpstart/privatelink/nested/cloud.json"
                },
                "mode": "Incremental",
                "parameters": {
                    "sqlAdminLogin": {
                        "value": "[parameters('sqlAdminLogin')]"
                    },
                    "sqlAdminPassword": {
                        "value": "[parameters('sqlAdminPassword')]"
                    },
                    "cloudVNetName": {
                        "value": "[parameters('cloudVNetName')]"
                    },
                    "cloudVNetPrefix": {
                        "value": "[parameters('cloudVNetPrefix')]"
                    },
                    "cloudSubnetName": {
                        "value": "[parameters('cloudSubnetName')]"
                    },
                    "cloudGatewaySubnetPrefix": {
                        "value": "[parameters('cloudGatewaySubnetPrefix')]"
                    },
                    "cloudSubnetPrefix": {
                        "value": "[parameters('cloudSubnetPrefix')]"
                    },
                    "cloudGatewayName": {
                        "value": "[parameters('cloudGatewayName')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "OnPremDeployment",
            "resourceGroup": "[parameters('onPremRgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups', parameters('onPremRgName'))]"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/DCMattyG/azure_arc/privatelink/azure_arc_servers_jumpstart/privatelink/nested/onprem.json"
                },
                "mode": "Incremental",
                "parameters": {
                    "vmName": {
                        "value": "[parameters('vmName')]"
                    },
                    "vmSize": {
                        "value": "[parameters('vmSize')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "onPremVNetName": {
                        "value": "[parameters('onPremVNetName')]"
                    },
                    "onPremVNetPrefix": {
                        "value": "[parameters('onPremVNetPrefix')]"
                    },
                    "onPremGatewaySubnetPrefix": {
                        "value": "[parameters('onPremGatewaySubnetPrefix')]"
                    },
                    "onPremBastionSubnetPrefix": {
                        "value": "[parameters('onPremBastionSubnetPrefix')]"
                    },
                    "onPremSubnetName": {
                        "value": "[parameters('onPremSubnetName')]"
                    },
                    "onPremSubnetPrefix": {
                        "value": "[parameters('onPremSubnetPrefix')]"
                    },
                    "onPremGatewayName": {
                        "value": "[parameters('onPremGatewayName')]"
                    },
                    "onPremBastionName": {
                        "value": "[parameters('onPremBastionName')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "ConnectAzureGateway",
            "resourceGroup": "[parameters('azureRgName')]",
            "dependsOn": [
                "AzureDeployment",
                "OnPremDeployment"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "azureGatewayName": {
                        "value": "[parameters('cloudGatewayName')]"
                    },
                    "onPremGatewayName": {
                        "value": "[parameters('onPremGatewayName')]"
                    },
                    "onPremGatewayResourceGroupName": {
                        "value": "[parameters('onPremRgName')]"
                    },
                    "sharedKey": {
                        "value": "[parameters('sharedKey')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "azureGatewayName": {
                            "type": "string"
                        },
                        "onPremGatewayName": {
                            "type": "string"
                        },
                        "onPremGatewayResourceGroupName": {
                            "type": "string"
                        },
                        "sharedKey": {
                            "type": "securestring"
                        }
                    },
                    "resources": [
                        {
                            "apiVersion": "2020-05-01",
                            "type": "Microsoft.Network/connections",
                            "name": "azure-to-onprem",
                            "location": "[resourceGroup().location]",
                            "properties": {
                                "virtualNetworkGateway1": {
                                    "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('azureGatewayName'))]"
                                },
                                "virtualNetworkGateway2": {
                                    "id": "[resourceId(parameters('onPremGatewayResourceGroupName'), 'Microsoft.Network/virtualNetworkGateways', parameters('onPremGatewayName'))]"
                                },
                                "connectionType": "Vnet2Vnet",
                                "routingWeight": 3,
                                "sharedKey": "[parameters('sharedKey')]"
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "ConnectOnPremGateway",
            "resourceGroup": "[parameters('onPremRgName')]",
            "dependsOn": [
                "ConnectAzureGateway"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "azureGatewayName": {
                        "value": "[parameters('cloudGatewayName')]"
                    },
                    "onPremGatewayName": {
                        "value": "[parameters('onPremGatewayName')]"
                    },
                    "azureGatewayResourceGroupName": {
                        "value": "[parameters('azureRgName')]"
                    },
                    "sharedKey": {
                        "value": "[parameters('sharedKey')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "onPremGatewayName": {
                            "type": "string"
                        },
                        "azureGatewayName": {
                            "type": "string"
                        },
                        "azureGatewayResourceGroupName": {
                            "type": "string"
                        },
                        "sharedKey": {
                            "type": "securestring"
                        }
                    },
                    "resources": [
                        {
                            "apiVersion": "2020-05-01",
                            "type": "Microsoft.Network/connections",
                            "name": "onprem-to-azure",
                            "location": "[resourceGroup().location]",
                            "properties": {
                                "virtualNetworkGateway1": {
                                    "id": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('onPremGatewayName'))]"
                                },
                                "virtualNetworkGateway2": {
                                    "id": "[resourceId(parameters('azureGatewayResourceGroupName'), 'Microsoft.Network/virtualNetworkGateways', parameters('azureGatewayName'))]"
                                },
                                "connectionType": "Vnet2Vnet",
                                "routingWeight": 3,
                                "sharedKey": "[parameters('sharedKey')]"
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "GetAccessToken",
            "resourceGroup": "[parameters('onPremRgName')]",
            "dependsOn": [
                "AzureDeployment",
                "OnPremDeployment"
            ],
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "roleAssignmentName": {
                        "value": "[reference('AzureDeployment').outputs.roleAssignmentName.value]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "roleAssignmentName": {
                            "type": "string"
                        }
                    },
                    "variables": {
                        "identityName": "deploy-identity",
                        "deploymentScriptName": "getAzureToken"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Resources/deploymentScripts",
                            "apiVersion": "2020-10-01",
                            "name": "[variables('deploymentScriptName')]",
                            "location": "[resourceGroup().location]",
                            "kind": "AzurePowerShell",
                            "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                    "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities',variables('identityName'))]": {}
                                }
                            },
                            "properties": {
                                "azPowerShellVersion": "6.6",
                                "scriptContent": "
                                    $token = $(Get-AzAccessToken).Token
                                    $DeploymentScriptOutputs = @{}
                                    $DeploymentScriptOutputs['token'] = $token
                                ",
                                "timeout": "PT30M",
                                "cleanupPreference": "OnSuccess",
                                "retentionInterval": "PT1H"
                            },
                            "dependsOn": [
                                "[resourceId('Microsoft.Authorization/roleAssignments', parameters('roleAssignmentName'))]"
                            ]
                        }
                    ],
                    "outputs": {
                        "token": {
                            "type": "string",
                            "value": "[reference(variables('deploymentScriptName')).outputs.token]"
                        }
                    }
                }
            }
        }
    ],
    "outputs": {
        "token": {
            "type": "string",
            "value": "[reference('GetAccessToken').outputs.token.value]"
        }
    }
}
